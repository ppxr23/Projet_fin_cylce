name: CI/CD Pipeline - Vivetic RH Platform

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
    
permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========================================
  # JOB 1: Tests Backend (Symfony)
  # ========================================
  backend-tests:
    name: Backend - Tests & Quality
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: vivetic_rh_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_pgsql
          coverage: xdebug
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/backend/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-progress --no-scripts --dev

      - name: Run Symfony setup scripts
        working-directory: ./backend
        run: |
          php bin/console cache:clear --no-warmup || true
          php bin/console importmap:install || true

      - name: Create JWT keys
        working-directory: ./backend
        run: |
          mkdir -p config/jwt
          openssl genpkey -algorithm RSA -out config/jwt/private.pem -pkeyopt rsa_keygen_bits:4096
          openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem

      - name: Create .env file
        working-directory: ./backend
        run: |
          echo "APP_ENV=test" > .env
          echo "APP_DEBUG=1" >> .env
          echo "DATABASE_URL=postgresql://postgres:postgres123@127.0.0.1:5432/vivetic_rh_test?serverVersion=16&charset=utf8" >> .env
          echo "MESSENGER_TRANSPORT_DSN=doctrine://default" >> .env

      - name: Setup database
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres123@localhost:5432/vivetic_rh_test
        run: |
          php bin/console doctrine:database:create --if-not-exists --env=test
          php bin/console doctrine:schema:create --env=test

      - name: Run PHPUnit tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres123@localhost:5432/vivetic_rh_test
        run: php vendor/bin/phpunit --coverage-clover coverage.xml

      # - name: Run PHPStan (Static Analysis)
      #   working-directory: ./backend
      #   run: vendor/bin/phpstan analyse src --level=8 --no-progress
      #   continue-on-error: true

      # - name: Run PHP CodeSniffer
      #   working-directory: ./backend
      #   run: vendor/bin/phpcs src --standard=PSR12 --report=summary
      #   continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage


  # ========================================
  # JOB 2: Tests Frontend (Vue.js)
  # ========================================
  frontend-tests:
    name: Frontend - Tests & Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Run ESLint
        run: npm run lint
        working-directory: ./frontend
        continue-on-error: true

      - name: Run unit tests
        run: npm run test:unit
        working-directory: ./frontend
        continue-on-error: true

      - name: Build application
        run: npm run build
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:8000

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ./frontend/dist
          retention-days: 1

  # ========================================
  # JOB 3: Security Scan (optionnel)
  # ========================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'

  # ========================================
  # JOB 4: Build Docker Images (local)
  # ========================================
  build-images:
    name: Build Docker Images Locally
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image-name
        run: echo "IMAGE_NAME_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image locally
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: false
          tags: ${{ env.IMAGE_NAME_LOWER }}-${{ matrix.service }}:latest
          
  # ========================================
  # JOB 5: Notification (simplifiée)
  # ========================================
  notify:
    name: Pipeline finished
    runs-on: ubuntu-latest
    needs: [build-images]
    steps:
      - run: echo "CI/CD pipeline terminé pour la branche ${{ github.ref }}"

# ========================================
# Jobs de déploiement (commentés pour usage local)
# ========================================
# deploy-staging:
#   name: Deploy to Staging
#   runs-on: ubuntu-latest
#   needs: build-images
#   if: github.ref == 'refs/heads/develop'
#   environment:
#     name: staging
#     url: https://staging.vivetic-rh.com
#   steps:
#     ...

# deploy-production:
#   name: Deploy to Production
#   runs-on: ubuntu-latest
#   needs: build-images
#   if: github.ref == 'refs/heads/main'
#   environment:
#     name: production
#     url: https://vivetic-rh.com
#   steps:
#     ...
